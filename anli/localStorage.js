BizQQWPA.define("wpa.visitor","util.log,util.speedReport,util.getJSONP,util.domain,util.pubSub,wpa.filter,wpa.ta,wpa.invite,wpa.wpaMgr,wpa.ta,wpa.kfuin",function(s){var m=s("invite"),r=s("domain"),v=s("filter"),t=s("getJSONP"),o=s("pubSub"),q=s("log"),u=s("speedReport"),p=s("ta"),w=s("kfuin");var n=1;var x="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_first_heart_beat.php";return function(f){var c=f.nameAccount;if(!c||c==="undefined"){return}if(m.isLoaded(c)||!v.TA){return}var e,a,b=function(g,h){if(!g||!h){return}if(h.block===n){return}if(v.CRM){h.di=f.di;h.kfuin=f.kfuin;q(c+" try launch slave");m.load(c,g,h)}};o.one("TA.loaded",function(g){e=g;b(e,a)});o.one("Invite.first",function(g){a=g;b(e,a)});p(c,r.topDomain,function(g){o.pub("TA.loaded",g)});var d={nameAccount:c,dm:r.topDomain,title:document.title,url:location.href.split("://")[1].split("?")[0]};t(x,d,function(g){o.pub("Invite.first",g)});f.kfuin&&w.set(c,f.kfuin)}});BizQQWPA.define("wpa.filter","util.domain",function(i){var f="",g="qq.com,pengyou.com,qzoneapp.com,nipic.com,docin.com,51zxw.net,2155.com,xd.com,yto.net.cn,c-c.com,27.cn,05wan.com,alivv.cn,gogo.com,doctorjob.com.cn,emoney.cn,m4.cn,chinaktv.net,yk988.com,bangkaow.com,wsxsp.com,55tools.com,youxi518.com",j="b.qq.com,sales.b.qq.com,guilin.house.qq.com,ta.qq.com,hn.qq.com,nantong.house.qq.com";var h=i("domain");return{TA:function(){var c=h.topDomain,d=/^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,a=/^localhost$/,b=/^wpa\.b\.qq\.com/;return f.indexOf(c)===-1&&!d.test(c)&&!a.test(c)&&!b.test(h.domain)}(),CRM:function(){try{var d=new RegExp("(^|,)"+h.domain);if(d.test(j)){return true}var e=h.topDomain,a=new RegExp("(^|,)"+e),l=/^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,c=/^localhost$/;return !a.test(g)&&!l.test(e)&&!c.test(e)}catch(b){}}()}});BizQQWPA.define("wpa.invite","util.log,util.getJSONP,util.proxy,util.domain,util.blockStorage,util.taskMgr,wpa.wpaMgr",function(a0){var aP=2000,an=1000,aI=2000,a3=2000,aJ=5000,ac=15000,ar=3600000,ae=1000;var aU="is",aq="ik",a4="msg",ay="mh",av="mid",aL="slid";var aK="0",ad="1",aE="2",aj="0",aB="-1",aC="|";var aQ="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_heart_beat.php",ah="http://visitor.crm2.qq.com/cgi/visitorcgi/ajax/auto_invite.php";var aO=0,az="0",ag="1",aS="2",a2=1;var af="0",aG="1",aV="2",aW="4",aD="20",au="0",aT="1",aY="2",aF="4",aA="5";var at="0",ap="1",aw="1",ax="0",aM="1";var aX=a0("log"),aH=a0("getJSONP"),ai=a0("proxy"),aR=a0("domain"),aZ=a0("blockStorage"),a1=a0("taskMgr"),ak=a0("wpaMgr");var al=function(a,b,c){this.nameAccount=a;this.uid=b;this.config=c;this.genID();this.storage=aZ(a);this.monitors={master:a1.newTask(ai(this,this.masterMonitor),aP).run(),invite:a1.newTask(ai(this,this.inviteMonitor),an).run()};this.heartBeat=a1.newTask(ai(this,this.heartBeatProcess),a3).run();this.setActive();window.onfocus=ai(this,this.setActive);aX("slave "+this.id+" launched!")};al.prototype={genID:function(){this.id="slid_"+ +new Date()%1000+"_"+Math.round(Math.random()*100)},masterMonitor:function(){if(aN[this.nameAccount]){return}aX("monitoring mater state");var b=this.storage.get(ay)||0,a=+new Date()-parseInt(b);aX("gap of master is "+a);if(a>3*aI){this.recoverMaster()}},recoverMaster:function(){aN[this.nameAccount]=new am(this.nameAccount,this.uid,this.config);aX("recover master by slave "+this.id)},inviteMonitor:function(){if(this.isInvited()){this.kill()}else{if(this.isInviting()){if(this.isActive()){this.invite()}}}aX("slave "+this.id+" monitoring invite state")},kill:function(){this.monitors.invite.drop();this.heartBeat.drop();var a=this.storage,b=[this.id];for(var c=0,d;d=b[c++];){a.del(d)}aX("slave "+this.id+" killed")},invite:function(){var b=this.storage.get(aq);var a={wty:aG,nameAccount:this.nameAccount,kfuin:this.config.kfuin,type:aD,aty:b?(b===aj?aF:aA):aF,a:b||"",iv:aM,fsty:at,fposX:aw,fposY:ap,sv:aW,uid:this.uid,dm:aR.topDomain,msg:this.storage.get(a4)};ak.invite(a,this.config.di);this.storage.set(aU,aE);aX("invited by slave "+this.id)},heartBeatProcess:function(){var a=this.storage,b=a.get(aL);if(!b){a.set(aL,this.id+"|")}else{if(b.indexOf(this.id+"|")===-1){a.set(aL,this.id+"|"+b)}}a.set(this.id,+new Date())},setActive:function(){var a=this.storage,b=a.get(aL)||"",c=this.id+aC;if(b.indexOf(this.id)>-1){b=b.replace(c,"")}b+=c;a.set(aL,b)},isActive:function(){var a=this.storage.get(aL);if(!a){return false}return a.substr(0,a.length-1).split(aC).pop()===this.id},isInvited:function(){return this.storage.get(aU)===aE},isInviting:function(){return this.storage.get(aU)===ad}};var aN={};var am=function(a,b,c){this.nameAccount=a;this.uid=b;this.config=c;this.storage=aZ(a);this.genID();this.sleep=false;this.heartBeatURl=c.hbDomain||aQ;this.storage.set(av,this.id);this.heartBeatProcess();this.heartBeat=a1.newTask(ai(this,this.heartBeatProcess),aI).run();this.initWithConfig();aX("master launched!")};am.prototype={genID:function(){this.id=+new Date()%1000+"_"+Math.round(Math.random()*100)},setInviteState:function(b,c,a){if(b===ad){this.storage.set(aq,c);this.storage.set(a4,a)}this.storage.set(aU,b)},isInvited:function(){var a=this.storage.get(aU)===aE;if(a){this.recycle();this.isInvited=function(){return true}}return a},initWithConfig:function(){var a=this.config;if(a.r!==aO){this.storage.set(ay,aB);return}if(a.isAuto===a2){this.storage.set(a4,a.autoMsg);this.autoInviteTimer=setTimeout(ai(this,function(){this.autoInvite()}),a.autoTime*1000)}this.monitors={slave:a1.newTask(ai(this,this.slaveMonitor),a3).run(),server:a1.newTask(ai(this,this.serverMonitor),aJ).run(),sleep:a1.newTask(ai(this,this.sleepMonitor),ar).run()};aX("master inited with config")},autoInvite:function(){if(this.isInvited()){return}var a={nameAccount:this.nameAccount,uid:this.uid};var b=this.monitors.server;b.pause();aH(ah,a,ai(this,function(c){if(c.r!==aO){b.run();return}if(!this.isInvited()){this.setInviteState(ad,aj,this.storage.get(a4));a1.once(function(){b.run()},5000).run()}}))},ajustServerMonitorGap:function(a){this.monitors.server.setGap(Math.min(Math.max(aJ,a),ac))},serverMonitor:function(){var a=this.storage.get(aU);if(this.sleep){return}var b={nameAccount:this.nameAccount,uid:this.uid};if(a===ad){b.inviteState=ag}if(a===aE){b.inviteState=aS}aH(this.heartBeatURl,b,ai(this,function(c){if(c.r!==aO){return}if(c.gap){this.ajustServerMonitorGap(c.gap*1000)}if(c.inviteState===az){return}if(c.inviteState===ag){this.setInviteState(ad,c.kfext,c.inviteMsg);return}if(c.inviteState===aS){this.setInviteState(aE)}}))},slaveMonitor:function(){if(this.isInvited()){this.monitors.slave.drop()}var h=this.storage,g=h.get(aL);if(!g){return}g=g.split(aC);var b="",c=+new Date(),d,f,a;for(var e=0;f=g[e++];){aX("monitoring slave "+f+" state");d=h.get(f)||0;a=c-parseInt(d);aX("gap of slave "+f+" is "+a);if(a>3*a3){h.del(f);aX("clear slave "+f+" in storage")}else{b+=f+aC}}h.set(aL,b)},sleepMonitor:function(){var b=this.storage.get(aL)||"",a=b.substr(0,b.length-1).split(aC).pop();if(this.sleep){if(this.activeSlave!==a){this.activeSlave=a;this.sleep=false;this.monitors.sleep.setGap(ar)}}else{if(this.activeSlave===a){this.sleep=true;this.monitors.sleep.setGap(ae)}else{this.activeSlave=a}}},kill:function(){aN[this.nameAccount]=undefined;if(this.monitors){this.monitors.server.drop();this.monitors.slave.drop();this.heartBeat.drop();clearTimeout(this.autoInviteTimer)}aX("master killed")},recycle:function(){var a=this.storage,b=[aq,a4];for(var c=0,d;d=b[c++];){a.del(d)}aX("storage recycled")},heartBeatProcess:function(){var a=this.storage;if(a.get(av)!==this.id){this.kill();return false}this.storage.set(ay,+new Date())}};var ao={};return{load:function(a,b,d){if(this.isLoaded(a)){aX(a+" slave already running");return}var c=new al(a,b,d);ao[a]?ao[a].push(c):ao[a]=[c]},isLoaded:function(a){return typeof ao[a]!=="undefined"}}});BizQQWPA.define("util.blockStorage","util.sessionStorage",function(e){var d=e("sessionStorage");var f=function(a){this.blockIndex=a};f.get=function(a){return d.get(a)};f.set=function(b,a){return d.set(b,a)};f.del=function(a){return d.del(a)};f.find=function(){return d.find.apply(d,arguments)};f.prototype={set:function(b,a){return d.setItem(this.blockIndex+b,a)},get:function(a){return d.getItem(this.blockIndex+a)},del:function(a){return d.removeItem(this.blockIndex+a)}};return factory=function(a){return new f(a)}});BizQQWPA.define("util.sessionStorage","util.localStorage,util.cookie",function(m){var n=m("util.localStorage"),k=m("util.cookie");var h="IESESSION";var j=function(){return !!k.get(h)},l=function(a){k.set(h,a,null,"/")},i=function(){var a=new RegExp("^"+h+"[\\S]+$"),c=[];for(var b=0;b<n.length;b++){if(n.key(b).match(a)){c.push(n.key(b))}}while(c.length){n.removeItem(c[0]);c.shift()}};if(!j()){l("alive");i()}return{setItem:function(b,a){n.setItem(h+b,a)},getItem:function(a){return n.getItem(h+a)},removeItem:function(a){n.removeItem(h+a)},clear:i}});BizQQWPA.define("util.localStorage","util.cookie,lang.trim",function(p){var r=p("util.cookie"),o=p("lang.trim");var k="IELS";var n=3153600000000;var l=document,j=new RegExp("(?:^|[ ;])"+k+"[^=]+=([^;$])"),q=function(a){return k+a},m=function(e){var c=l.cookie.split(";"),a=0,f=c.length,d=[],b;if(e){for(;a<f;a++){if(b=j.exec(c[a])){d.push(b[1]);e(b[1])}}}else{for(;a<f;a++){(b=j.exec(c[a]))&&d.push(b[1])}}return d};return window.localStorage||{length:m().length,key:function(a){return m()[a]||null},getItem:function(a){return r.get(q(a))},setItem:function(b,a){r.set(q(b),a,null,"/",n)},removeItem:function(a){r.del(a)},clear:function(){m(function(a){r.del(o(a.split("=")[0]))})}}});
